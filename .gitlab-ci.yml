image: php:8.2

services:
  - mysql:latest

variables:
  MYSQL_DATABASE: u625132372_laraforum
  MYSQL_ROOT_PASSWORD: secret
  DB_CONNECTION: mysql
  DB_HOST: mysql
  DB_PORT: 3306
  DB_DATABASE: u625132372_laraforum
  DB_USERNAME: root
  DB_PASSWORD: secret

stages:
  - build
  - test
  - deploy

cache:
  paths:
    - vendor/

before_script:
  - apt-get update -y
  - apt-get install -y nodejs npm
  - apt-get install -y libpng-dev libjpeg-dev libfreetype6-dev
  - apt-get install -y zip libzip-dev
  - docker-php-ext-configure gd --with-freetype --with-jpeg
  - docker-php-ext-install gd
  - docker-php-ext-install pdo_mysql zip
  - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
  - npm install -g dotenv-cli
  - echo "APP_ENV=testing" >> .env
  - echo "DB_CONNECTION=$DB_CONNECTION" >> .env
  - echo "DB_HOST=$DB_HOST" >> .env
  - echo "DB_PORT=$DB_PORT" >> .env
  - echo "DB_DATABASE=$DB_DATABASE" >> .env
  - echo "DB_USERNAME=$DB_USERNAME" >> .env
  - echo "DB_PASSWORD=$DB_PASSWORD" >> .env
  - echo "MAIL_HOST=$MAIL_HOST" >> .env
  - echo "MAIL_PORT=$MAIL_PORT" >> .env
  - echo "MAIL_USERNAME=$MAIL_USERNAME" >> .env
  - echo "MAIL_PASSWORD=$MAIL_PASSWORD" >> .env
  - echo "MAIL_ENCRYPTION=$MAIL_ENCRYPTION" >> .env
  - composer install --prefer-dist --no-ansi --no-interaction --no-progress --no-scripts --optimize-autoloader
  - cp .env.example .env
  - php artisan key:generate
  - php artisan migrate --env=testing

build:
  stage: build
  script:
    - echo "Building the application..."

test:
  stage: test
  script:
    - php artisan test --env=testing

deploy:
  stage: deploy
  script:
    - echo "Deploying application..."
    - apt-get update -y
    - apt-get install -y sshpass
    - sshpass -p $SSH_PASSWORD ssh -p $SSH_PORT -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "cd /public_html/laraforum && git pull origin main && composer install && php artisan migrate --force && php artisan config:cache && php artisan route:cache && php artisan view:cache"
  only:
    - master
  environment:
    name: production
    url: http://laraforum.chang180backend.com
